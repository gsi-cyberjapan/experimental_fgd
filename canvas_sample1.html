<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title></title>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="./TileLayer.GeoJSON.js"></script>
<script src="./leaflet-hash.js"></script>
<style>
body {padding: 0; margin: 0}
html, body, #mapdiv {height: 100%; width: 100%;}
.leaflet-container {background: #fff;}
</style>
</head>
<body>
<div id="mapdiv">
<script>

function tilexy(tilePoint,zoom,dz,canvas_dx,canvas_dy,tlng,tlat){
      var tileSize=256;
      var tz = zoom;
      if(dz>0){tileSize = 256*Math.pow(2, dz);tz = tz -dz;}
      var initialResolution = 2 * Math.PI / tileSize;
      var Resolution = initialResolution / (Math.pow(2, tz));
      var originShift = 2 * Math.PI / 2.0;
      var X = tlng * (Math.PI / 180) ;
      var Y=Math.log(Math.tan(Math.PI/4 + tlat * (Math.PI / 180) / 2) );
      var tx=(X + originShift)/(tileSize * Resolution);
      var ty=(Y + originShift)/(tileSize * Resolution);
      ty = Math.pow(2, tz) - ty;
      tx=(tx-tilePoint.x)*tileSize+canvas_dx;
      ty=(ty-tilePoint.y)*tileSize+canvas_dy;
      return ([tx,ty]);
}

function cl_geturl(tilePoint,zoom,dz){
	var url_x =  "";
	var url_y =  "";
	var url_a = [];
	if(dz<0){
	 var num =Math.pow(2, Math.abs(dz));
	 for ( var i=0; i<num; i++ ){
	  	url_x =  i+Math.floor(tilePoint.x / Math.pow(2, dz));
	  	for ( var ii=0; ii<num;  ii++ ){
	  		url_y =  ii+Math.floor(tilePoint.y / Math.pow(2, dz));
	  		url_a.push("/"+url_x+"/"+url_y+".geojson");
	  	}
	 }
	}else{
	 url_x =  tilePoint.x;
	 url_y =  tilePoint.y;
	 url_a.push("/"+url_x+"/"+url_y+".geojson");
	}
	return url_a;
}

function featsearch(layerdata,tilePoint,zoom,dz,canvas,canvas_dx,canvas_dy,urlid){
 if ( !layerdata ) return;
 var ctx = canvas.getContext('2d');
 for ( var i=0; i<layerdata.length; i++ ){
  if ( layerdata[i].geometry.type != 'LineString' ) continue;
  var s;
  switch (urlid){
       case 'experimental_rdcl':
         s = rdcl_style(layerdata[i]);
         break;
       case 'experimental_railcl':
         s = railcl_style(layerdata[i]);
         break;
       case 'experimental_rvrcl':
         s = rvrcl_style(layerdata[i]);
         break;
       case 'experimental_fgd':
         s = fgd_style(layerdata[i]);
         break;
  }
   for ( var a in s){
    if(a=='setLineDash'){
     if(ctx.setLineDash!==undefined){
      ctx.setLineDash(s[a]);
     }
     continue;
    }
    ctx[a] = s[a];
   }
   ctx.beginPath();
   for ( var ii=0; ii<layerdata[i].geometry.coordinates.length; ii++ ){
    var test = tilexy(tilePoint,zoom,dz,canvas_dx,canvas_dy,layerdata[i].geometry.coordinates[ii][0],layerdata[i].geometry.coordinates[ii][1]);
    if(ii==0){ctx.moveTo(test[0], test[1]);}else{ctx.lineTo(test[0], test[1]);}
   }
   ctx.stroke();
 }
}


//基盤地図情報基本項目スタイル
function fgd_style(feature){
     switch (feature.properties['class']){
       case 'Cstline':
        return {setLineDash:[],strokeStyle:"#00f",lineWidth:2,globalAlpha:0.5,lineCap:"butt"};
       case 'Cntr':
        return {setLineDash:[],strokeStyle:"#ca5",lineWidth:0,globalAlpha:0.5,lineCap:"butt"};
       case 'WStrL':
        return {setLineDash:[],strokeStyle:"#77f",lineWidth:1,globalAlpha:0.5,lineCap:"butt"};
       case 'WL':
        return {setLineDash:[],strokeStyle:"#00f",lineWidth:2,globalAlpha:0.5,lineCap:"butt"};
       case 'RdEdg':
        return {setLineDash:[],strokeStyle:"#777",lineWidth:2,globalAlpha:0.5,lineCap:"butt"};
       case 'RdCompt':
        return {setLineDash:[],strokeStyle:"#aaa",lineWidth:1,globalAlpha:0.5,lineCap:"butt"};
       case 'RailCL':
        return {setLineDash:[],strokeStyle:"#7f7",lineWidth:2,globalAlpha:0.5,lineCap:"butt"};
       case 'BldL':
        if(feature.properties['type']=='堅ろう建物'){
          return {setLineDash:[],strokeStyle:"#f72",lineWidth:2,globalAlpha:0,lineCap:"butt"};
         }else{
          return {setLineDash:[],strokeStyle:"#f72",lineWidth:1,globalAlpha:0,lineCap:"butt"};
        }
       case 'SBBdry':
        return {setLineDash:[5,5],strokeStyle:"#fbb",lineWidth:2,globalAlpha:0,lineCap:"butt"};
       case 'CommBdry':
        if(feature.properties['vis']=="非表示"){return {setLineDash:[10,10],strokeStyle:"#f77",lineWidth:0,globalAlpha:0,lineCap:"butt"};}else{
        return {setLineDash:[10,10],strokeStyle:"#f77",lineWidth:2,globalAlpha:0,lineCap:"butt"};}
       case 'AdmBdry':
        if(feature.properties['vis']=="非表示"){return {setLineDash:[10,10],strokeStyle:"#f77",lineWidth:0,globalAlpha:0,lineCap:"butt"};}else{
        return {setLineDash:[10,10],strokeStyle:"#f77",lineWidth:4,globalAlpha:0,lineCap:"butt"};}
     }
}

//基盤地図情報基本項目レイヤ
var fgdlayer = L.tileLayer.canvas({attribution:"基盤地図情報_基本項目",minZoom:15,maxNativeZoom:18,maxZoom:18,async:true});
fgdlayer.drawTile = function(canvas, tilePoint, zoom) {
	if(zoom>this.options.minZoom){
	var urlid = "experimental_fgd";
	var dz = zoom - this.options.maxNativeZoom;
	var canvas_dx = 20;
	var canvas_dy = 20;
	if(dz>0){
	 canvas.width=256*Math.pow(2, dz) + canvas_dx *2;
	 canvas.height=256*Math.pow(2, dz) + canvas_dy *2;
	}else{
	 canvas.width=256 + canvas_dx *2;
	 canvas.height=256 + canvas_dy *2;
	}
	var ctx = canvas.getContext('2d');
	ctx.fillStyle = '#fff';
	ctx.globalAlpha=0;
	ctx.fillRect(0, 0, canvas.width, canvas.height);
	this.tileDrawn(canvas);
	var url_a = cl_geturl(tilePoint,zoom,dz);
	var flag =0;
	var that = this;
	for ( var i=0; i<url_a.length; i++ ){
		var xhr = new XMLHttpRequest();
		xhr.onload = function() {
			if(flag==0){
			flag=1;
			canvas.style.left = canvas.offsetLeft - canvas_dx + 'px';
			canvas.style.top = canvas.offsetTop - canvas_dy + 'px';
			}
			var cl_json = JSON.parse(this.responseText);
			featsearch(cl_json.features,tilePoint,zoom,dz,canvas,canvas_dx,canvas_dy,urlid);
			that.tileDrawn(canvas);
		};
		xhr.open("get", 'http://cyberjapandata.gsi.go.jp/xyz/'+urlid+'/'+ this.options.maxNativeZoom +url_a[i], true);
		xhr.send();
	}
	}else{
	var ctx = canvas.getContext('2d');
	ctx.fillStyle = '#fff';
	ctx.globalAlpha=0;
	ctx.fillRect(0, 0, 256, 256);
	this.tileDrawn(canvas);
	}
}



var std = L.tileLayer(
'http://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
{attribution: "地理院タイル（標準地図）", 
maxNativeZoom: 18, maxZoom: 18, opacity:1});
var ort = L.tileLayer(
'http://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg',
{attribution: "地理院タイル（オルソ）", 
maxNativeZoom: 17, maxZoom: 18, opacity:0.7});

var blank = L.tileLayer(
'http://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png',
{attribution: "地理院タイル（白地図）", 
maxNativeZoom: 14, maxZoom: 15, opacity:1});

var GSI = {
	GLOBALS : {}
};

GSI.GLOBALS.map = L.map('mapdiv', {
  center: [35.705698,139.957527], zoom: 17,minZoom: 2, maxZoom: 18,
  layers: [blank,fgdlayer]});

L.control.scale({imperial: false}).addTo(GSI.GLOBALS.map);

//var baseLayers = {"地理院タイル（標準地図）": std,"地理院タイル（オルソ）": ort,"地理院タイル（白地図）": blank};
var baseLayers ={};
var overlays = {"地理院タイル（標準地図）": std,"地理院タイル（オルソ）": ort,"地理院タイル（白地図）": blank,'基盤地図情報基本項目': fgdlayer};

L.control.layers(baseLayers, overlays,{position:'topright',collapsed:true}).addTo(GSI.GLOBALS.map);
var hash = L.hash(GSI.GLOBALS.map);
</script>
</body>
</html>
